// AI Prompts Library - Database Schema
// Based on PRD v2 data models
// See: context/PRD.md for complete specifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum PromptStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// MODELS
// ============================================================================

/// User accounts (authenticated via OAuth)
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  image       String?
  isAdmin     Boolean  @default(false) @map("is_admin")
  createdAt   DateTime @default(now()) @map("created_at")
  lastLoginAt DateTime @updatedAt @map("last_login_at")

  // Relations
  submittedPrompts     Prompt[]      @relation("SubmittedBy")
  approvedPrompts      Prompt[]      @relation("ApprovedBy")
  submittedEdits       PromptEdit[]  @relation("SuggestedBy")
  reviewedEdits        PromptEdit[]  @relation("ReviewedBy")
  adminActions         AdminAction[]

  @@map("users")
}

/// AI Prompts submitted by users
model Prompt {
  id             String       @id @default(cuid())
  slug           String       @unique
  title          String
  promptText     String       @map("prompt_text") @db.Text
  description    String?
  exampleOutput  String?      @map("example_output") @db.Text
  category       String

  // Attribution
  authorName     String       @map("author_name")
  authorUrl      String?      @map("author_url")
  submittedById  String?      @map("submitted_by_user_id")
  submittedBy    User?        @relation("SubmittedBy", fields: [submittedById], references: [id])

  // Status
  status         PromptStatus @default(PENDING)
  rejectionReason String?     @map("rejection_reason")
  featured       Boolean      @default(false)

  // Metadata
  viewCount      Int          @default(0) @map("view_count")
  copyCount      Int          @default(0) @map("copy_count")

  // Timestamps
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  approvedAt     DateTime?    @map("approved_at")
  approvedById   String?      @map("approved_by_user_id")
  approvedBy     User?        @relation("ApprovedBy", fields: [approvedById], references: [id])
  deletedAt      DateTime?    @map("deleted_at")

  // Relations
  tags           PromptTag[]
  edits          PromptEdit[]

  // Indexes for performance
  @@index([slug])
  @@index([status, createdAt])
  @@index([status, featured, approvedAt])
  @@map("prompts")
}

/// Tags for categorizing prompts
model Tag {
  id         String      @id @default(cuid())
  name       String      @unique
  slug       String      @unique
  usageCount Int         @default(0) @map("usage_count")
  createdAt  DateTime    @default(now()) @map("created_at")

  // Relations
  prompts    PromptTag[]

  @@index([slug])
  @@map("tags")
}

/// Junction table for Prompt <-> Tag many-to-many relationship
model PromptTag {
  promptId String @map("prompt_id")
  tagId    String @map("tag_id")

  prompt   Prompt @relation(fields: [promptId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([promptId, tagId])
  @@map("prompt_tags")
}

/// Suggested improvements to existing prompts
model PromptEdit {
  id          String       @id @default(cuid())
  promptId    String       @map("prompt_id")
  prompt      Prompt       @relation(fields: [promptId], references: [id], onDelete: Cascade)

  // Proposed changes
  title           String
  promptText      String  @map("prompt_text") @db.Text
  description     String?
  exampleOutput   String? @map("example_output") @db.Text
  category        String
  changeDescription String @map("change_description") @db.Text

  // Attribution
  suggestedByName String  @map("suggested_by_name")
  suggestedById   String? @map("suggested_by_user_id")
  suggestedBy     User?   @relation("SuggestedBy", fields: [suggestedById], references: [id])

  // Status
  status          ReviewStatus @default(PENDING)
  rejectionReason String?      @map("rejection_reason")

  // Timestamps
  createdAt      DateTime  @default(now()) @map("created_at")
  reviewedAt     DateTime? @map("reviewed_at")
  reviewedById   String?   @map("reviewed_by_user_id")
  reviewedBy     User?     @relation("ReviewedBy", fields: [reviewedById], references: [id])

  @@index([promptId, status])
  @@map("prompt_edits")
}

/// Audit log for admin actions
model AdminAction {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id])
  action     String
  targetType String   @map("target_type")
  targetId   String   @map("target_id")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([targetType, targetId])
  @@map("admin_actions")
}
