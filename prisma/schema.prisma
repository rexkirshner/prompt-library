generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model admin_actions {
  id          String   @id
  user_id     String
  action      String
  target_type String
  target_id   String
  metadata    Json?
  created_at  DateTime @default(now())
  users       users    @relation(fields: [user_id], references: [id])

  @@index([target_type, target_id])
  @@index([user_id, created_at])
}

model user_actions {
  id         String   @id
  user_id    String
  action     String
  ip_address String?
  user_agent String?
  metadata   Json?
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id])

  @@index([user_id, created_at])
  @@index([action, created_at])
}

model prompt_edits {
  id                                             String       @id
  prompt_id                                      String
  title                                          String
  prompt_text                                    String
  description                                    String?
  example_output                                 String?
  category                                       String
  change_description                             String
  suggested_by_name                              String
  suggested_by_user_id                           String?
  status                                         ReviewStatus @default(PENDING)
  rejection_reason                               String?
  created_at                                     DateTime     @default(now())
  reviewed_at                                    DateTime?
  reviewed_by_user_id                            String?
  prompts                                        prompts      @relation(fields: [prompt_id], references: [id], onDelete: Cascade)
  users_prompt_edits_reviewed_by_user_idTousers  users?       @relation("prompt_edits_reviewed_by_user_idTousers", fields: [reviewed_by_user_id], references: [id])
  users_prompt_edits_suggested_by_user_idTousers users?       @relation("prompt_edits_suggested_by_user_idTousers", fields: [suggested_by_user_id], references: [id])

  @@index([prompt_id, status])
}

model prompt_tags {
  prompt_id String
  tag_id    String
  prompts   prompts @relation(fields: [prompt_id], references: [id], onDelete: Cascade)
  tags      tags    @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@id([prompt_id, tag_id])
}

model prompts {
  id                                        String                       @id
  slug                                      String                       @unique
  title                                     String
  prompt_text                               String?
  description                               String?
  example_output                            String?
  category                                  String
  author_name                               String
  author_url                                String?
  submitted_by_user_id                      String?
  status                                    PromptStatus                 @default(PENDING)
  rejection_reason                          String?
  featured                                  Boolean                      @default(false)
  ai_generated                              Boolean                      @default(false)
  view_count                                Int                          @default(0)
  copy_count                                Int                          @default(0)
  is_compound                               Boolean                      @default(false)
  max_depth                                 Int?
  created_at                                DateTime                     @default(now())
  updated_at                                DateTime                     @updatedAt
  approved_at                               DateTime?
  approved_by_user_id                       String?
  deleted_at                                DateTime?
  prompt_edits                              prompt_edits[]
  prompt_tags                               prompt_tags[]
  users_prompts_approved_by_user_idTousers  users?                       @relation("prompts_approved_by_user_idTousers", fields: [approved_by_user_id], references: [id])
  users_prompts_submitted_by_user_idTousers users?                       @relation("prompts_submitted_by_user_idTousers", fields: [submitted_by_user_id], references: [id])
  user_preferences                          user_prompt_preferences[]
  compound_components                       compound_prompt_components[] @relation("CompoundPrompt")
  used_in_compounds                         compound_prompt_components[] @relation("ComponentPrompt")

  @@index([slug])
  @@index([status, created_at])
  @@index([status, featured, approved_at])
  @@index([category])
  @@index([deleted_at])
  @@index([status, deleted_at])
  @@index([is_compound])
  // Phase 2 optimization indexes (added 2025-12-19)
  @@index([is_compound, status, deleted_at]) // For compound prompt filtering
  @@index([ai_generated, status, deleted_at]) // For "hide AI" filter
  @@index([copy_count]) // For popular sort (most copied)
}

model compound_prompt_components {
  id                  String   @id @default(cuid())
  compound_prompt_id  String
  component_prompt_id String?
  position            Int
  custom_text_before  String?
  custom_text_after   String?
  created_at          DateTime @default(now())
  compound_prompt     prompts  @relation("CompoundPrompt", fields: [compound_prompt_id], references: [id], onDelete: Cascade)
  component_prompt    prompts? @relation("ComponentPrompt", fields: [component_prompt_id], references: [id], onDelete: Restrict)

  @@unique([compound_prompt_id, position])
  @@index([component_prompt_id])
  @@index([compound_prompt_id, position])
}

model tags {
  id          String        @id
  name        String        @unique
  slug        String        @unique
  usage_count Int           @default(0)
  created_at  DateTime      @default(now())
  prompt_tags prompt_tags[]

  @@index([slug])
  @@index([usage_count])
}

model users {
  id                                                    String          @id
  email                                                 String          @unique
  password                                              String?
  name                                                  String?
  image                                                 String?
  is_admin                                              Boolean         @default(false)
  invited_by                                            String?
  created_at                                            DateTime        @default(now())
  last_login_at                                         DateTime?
  copy_prefix                                           String?
  copy_suffix                                           String?
  copy_add_prefix                                       Boolean         @default(false)
  copy_add_suffix                                       Boolean         @default(false)
  copy_use_ultrathink                                   Boolean         @default(false)
  copy_github_reminder                                  Boolean         @default(false)
  copy_remove_paste_placeholders                        Boolean         @default(false)
  sort_preference                                       String          @default("newest")
  hide_ai_generated                                     Boolean         @default(false)
  admin_actions                                         admin_actions[]
  user_actions                                          user_actions[]
  prompt_edits_prompt_edits_reviewed_by_user_idTousers  prompt_edits[]  @relation("prompt_edits_reviewed_by_user_idTousers")
  prompt_edits_prompt_edits_suggested_by_user_idTousers prompt_edits[]  @relation("prompt_edits_suggested_by_user_idTousers")
  prompts_prompts_approved_by_user_idTousers            prompts[]       @relation("prompts_approved_by_user_idTousers")
  prompts_prompts_submitted_by_user_idTousers           prompts[]       @relation("prompts_submitted_by_user_idTousers")
  accounts                                              Account[]
  sessions                                              Session[]
  inviter                                               users?                      @relation("UserInvites", fields: [invited_by], references: [id])
  invited_users                                         users[]                     @relation("UserInvites")
  created_invites                                       invite_codes[]              @relation("InviteCreator")
  redeemed_invite                                       invite_codes?               @relation("InviteRedeemer")
  prompt_preferences                                    user_prompt_preferences[]

  @@index([invited_by])
}

enum PromptStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model invite_codes {
  id         String    @id @default(uuid())
  code       String    @unique @default(uuid())
  created_by String
  created_at DateTime  @default(now())
  used_by    String?   @unique
  used_at    DateTime?
  creator    users     @relation("InviteCreator", fields: [created_by], references: [id], onDelete: Cascade)
  redeemer   users?    @relation("InviteRedeemer", fields: [used_by], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([created_by])
  @@index([used_by])
}

model user_prompt_preferences {
  id                   String   @id @default(uuid())
  user_id              String
  prompt_id            String
  copy_prefix          String?
  copy_suffix          String?
  copy_add_prefix      Boolean  @default(false)
  copy_add_suffix      Boolean  @default(false)
  copy_use_ultrathink              Boolean  @default(false)
  copy_github_reminder             Boolean  @default(false)
  copy_remove_paste_placeholders   Boolean  @default(false)
  created_at                       DateTime @default(now())
  updated_at                       DateTime @updatedAt
  user                             users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  prompt                           prompts  @relation(fields: [prompt_id], references: [id], onDelete: Cascade)

  @@unique([user_id, prompt_id])
  @@index([user_id])
  @@index([prompt_id])
}
